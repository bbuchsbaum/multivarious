<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cross-validation for Dimensionality Reduction • multivarious</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cross-validation for Dimensionality Reduction">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">multivarious</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Classifier.html">Classifying in latent space: k-NN &amp; Random-Forest wrappers</a></li>
    <li><a class="dropdown-item" href="../articles/Composing_Projectors.html">Composing Projectors: Chaining Models</a></li>
    <li><a class="dropdown-item" href="../articles/CPCAplus.html">Contrastive PCA: Finding What's Different Between Groups</a></li>
    <li><a class="dropdown-item" href="../articles/CrossValidation.html">Cross-validation for Dimensionality Reduction</a></li>
    <li><a class="dropdown-item" href="../articles/Extending.html">Extending multiblock: CCA and glmnet Examples</a></li>
    <li><a class="dropdown-item" href="../articles/Introduction.html">Introduction to the multivarious Package</a></li>
    <li><a class="dropdown-item" href="../articles/Multiblock.html">Multiblock basics: one projector, many tables</a></li>
    <li><a class="dropdown-item" href="../articles/Nystrom.html">Kernel PCA Made Fast: The Nyström Approximation</a></li>
    <li><a class="dropdown-item" href="../articles/Partial_Projection.html">Partial projection: working with incomplete feature sets</a></li>
    <li><a class="dropdown-item" href="../articles/PermutationTesting.html">Permutation Testing in multivarious</a></li>
    <li><a class="dropdown-item" href="../articles/PreProcessing.html">Pre-processing pipelines in multiblock</a></li>
    <li><a class="dropdown-item" href="../articles/Regress.html">Linear Re-representation with regress()</a></li>
    <li><a class="dropdown-item" href="../articles/SVD_PCA.html">SVD wrapper, PCA and the bi_projector</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Cross-validation for Dimensionality Reduction</h1>
            
      

      <div class="d-none name"><code>CrossValidation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="why-cross-validate-dimensionality-reduction">Why Cross-validate Dimensionality Reduction?<a class="anchor" aria-label="anchor" href="#why-cross-validate-dimensionality-reduction"></a>
</h2>
<p>When using PCA or other dimensionality reduction methods, we often
face questions like: - How many components should I keep? - How well
does my model generalize to new data? - Which preprocessing strategy
works best?</p>
<p>Cross-validation provides principled answers by testing how well
models trained on one subset of data perform on held-out data.</p>
</div>
<div class="section level2">
<h2 id="quick-example-finding-the-right-number-of-components">Quick Example: Finding the Right Number of Components<a class="anchor" aria-label="anchor" href="#quick-example-finding-the-right-number-of-components"></a>
</h2>
<p>Let’s use the iris dataset to demonstrate:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 150 samples × 4 features</span></span>
<span></span>
<span><span class="co"># Create 5-fold cross-validation splits</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">fold_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fold_ids</span> <span class="op">!=</span> <span class="va">k</span><span class="op">)</span>,</span>
<span>  test  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fold_ids</span> <span class="op">==</span> <span class="va">k</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define fitting and measuring functions for PCA cross-validation</span></span>
<span><span class="va">fit_pca</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">ncomp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/pca.html">pca</a></span><span class="op">(</span><span class="va">train_data</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, preproc <span class="op">=</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">measure_pca</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Reconstruct test data using the model</span></span>
<span>  <span class="va">test_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="va">reconstructed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconstruct.html">reconstruct</a></span><span class="op">(</span><span class="va">model</span>, scores <span class="op">=</span> <span class="va">test_scores</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Measure reconstruction error</span></span>
<span>  <span class="fu"><a href="../reference/measure_reconstruction_error.html">measure_reconstruction_error</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="va">reconstructed</span>, metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rmse"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run cross-validation for different numbers of components</span></span>
<span><span class="va">results_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">ncomp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cv_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">X</span>,</span>
<span>    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>    .fit_fun <span class="op">=</span> <span class="va">fit_pca</span>,</span>
<span>    .measure_fun <span class="op">=</span> <span class="va">measure_pca</span>,</span>
<span>    fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="va">ncomp</span><span class="op">)</span>,</span>
<span>    backend <span class="op">=</span> <span class="st">"serial"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">cv_res</span><span class="op">$</span><span class="va">ncomp</span> <span class="op">&lt;-</span> <span class="va">ncomp</span></span>
<span>  <span class="va">cv_res</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span></span>
<span><span class="co"># Combine results</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">ncomp</span>, rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `results`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(x$results$rmse, na.rm = TRUE): argument is not numeric</span></span>
<span><span class="co">#&gt; or logical: returning NA</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `results`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(x$results$rmse, na.rm = TRUE): argument is not numeric</span></span>
<span><span class="co">#&gt; or logical: returning NA</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `results`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(x$results$rmse, na.rm = TRUE): argument is not numeric</span></span>
<span><span class="co">#&gt; or logical: returning NA</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `results`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(x$results$rmse, na.rm = TRUE): argument is not numeric</span></span>
<span><span class="co">#&gt; or logical: returning NA</span></span>
<span></span>
<span><span class="co"># View results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cv_results</span><span class="op">)</span></span>
<span><span class="co">#&gt;    ncomp rmse</span></span>
<span><span class="co">#&gt; 1      1   NA</span></span>
<span><span class="co">#&gt; 2      1   NA</span></span>
<span><span class="co">#&gt; 3      1   NA</span></span>
<span><span class="co">#&gt; 4      1   NA</span></span>
<span><span class="co">#&gt; 5      1   NA</span></span>
<span><span class="co">#&gt; 6      2   NA</span></span>
<span><span class="co">#&gt; 7      2   NA</span></span>
<span><span class="co">#&gt; 8      2   NA</span></span>
<span><span class="co">#&gt; 9      2   NA</span></span>
<span><span class="co">#&gt; 10     2   NA</span></span>
<span><span class="co">#&gt; 11     3   NA</span></span>
<span><span class="co">#&gt; 12     3   NA</span></span>
<span><span class="co">#&gt; 13     3   NA</span></span>
<span><span class="co">#&gt; 14     3   NA</span></span>
<span><span class="co">#&gt; 15     3   NA</span></span>
<span><span class="co">#&gt; 16     4   NA</span></span>
<span><span class="co">#&gt; 17     4   NA</span></span>
<span><span class="co">#&gt; 18     4   NA</span></span>
<span><span class="co">#&gt; 19     4   NA</span></span>
<span><span class="co">#&gt; 20     4   NA</span></span></code></pre></div>
<p>The plot shows that 2 components capture most of the variance, with
diminishing returns after that.</p>
</div>
<div class="section level2">
<h2 id="understanding-the-output">Understanding the Output<a class="anchor" aria-label="anchor" href="#understanding-the-output"></a>
</h2>
<p>The <code><a href="../reference/cv_generic.html">cv_generic()</a></code> function returns a tibble
containing:</p>
<ul>
<li>
<strong>fold</strong>: The fold number</li>
<li>
<strong>model</strong>: The fitted model for each fold (stored as a
list column)</li>
<li>
<strong>metrics</strong>: Performance metrics for each fold (stored
as a list column of tibbles)</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View the structure of CV results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, max.level <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [5 × 4] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ fold   : int [1:5] 1 2 3 4 5</span></span>
<span><span class="co">#&gt;  $ model  :List of 5</span></span>
<span><span class="co">#&gt;  $ metrics:List of 5</span></span>
<span><span class="co">#&gt;  $ ncomp  : int [1:5] 1 1 1 1 1</span></span>
<span></span>
<span><span class="co"># Extract and combine all metrics across folds</span></span>
<span><span class="va">all_fold_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    ncomp <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">ncomp</span>,</span>
<span>    fold_metrics <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">all_fold_metrics</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ncomp                                    error</span></span>
<span><span class="co">#&gt; 1     1 all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; 2     1 all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; 3     1 all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; 4     1 all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; 5     1 all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="custom-cross-validation-scenarios">Custom Cross-validation Scenarios<a class="anchor" aria-label="anchor" href="#custom-cross-validation-scenarios"></a>
</h2>
<div class="section level3">
<h3 id="scenario-1-comparing-preprocessing-strategies">Scenario 1: Comparing Preprocessing Strategies<a class="anchor" aria-label="anchor" href="#scenario-1-comparing-preprocessing-strategies"></a>
</h3>
<p>Use <code><a href="../reference/cv_generic.html">cv_generic()</a></code> to compare different preprocessing
pipelines:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define two preprocessing strategies</span></span>
<span><span class="va">prep1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span>                       <span class="co"># Center only</span></span>
<span><span class="va">prep2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/colscale.html">colscale</a></span><span class="op">(</span><span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"z"</span><span class="op">)</span> <span class="co"># Center and scale (z-score)</span></span>
<span></span>
<span><span class="co"># Fit function that uses PCA with preprocessing</span></span>
<span><span class="va">fit_with_prep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">ncomp</span>, <span class="va">preproc</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># PCA will handle preprocessing internally</span></span>
<span>  <span class="fu"><a href="../reference/pca.html">pca</a></span><span class="op">(</span><span class="va">train_data</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, preproc <span class="op">=</span> <span class="va">preproc</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Measure function that handles preprocessing</span></span>
<span><span class="va">measure_with_prep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Project and reconstruct - PCA handles preprocessing automatically</span></span>
<span>  <span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="va">recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconstruct.html">reconstruct</a></span><span class="op">(</span><span class="va">model</span>, scores <span class="op">=</span> <span class="va">scores</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate metrics</span></span>
<span>  <span class="fu"><a href="../reference/measure_reconstruction_error.html">measure_reconstruction_error</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="va">recon</span>,</span>
<span>                               metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rmse"</span>, <span class="st">"r2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compare both strategies</span></span>
<span><span class="va">cv_prep1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>, <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_with_prep</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_with_prep</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">3</span>, preproc <span class="op">=</span> <span class="va">prep1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span></span>
<span><span class="va">cv_prep2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>, <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_with_prep</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_with_prep</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">3</span>, preproc <span class="op">=</span> <span class="va">prep2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span></span>
<span><span class="co"># Compare results - extract metrics from the tibble</span></span>
<span><span class="va">metrics1</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cv_prep1</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span><span class="va">metrics2</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cv_prep2</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Center only - RMSE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">metrics1</span><span class="op">$</span><span class="va">rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `rmse`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(metrics1$rmse, na.rm = TRUE): argument is not numeric</span></span>
<span><span class="co">#&gt; or logical: returning NA</span></span>
<span><span class="co">#&gt; Center only - RMSE: NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Center + Scale - RMSE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">metrics2</span><span class="op">$</span><span class="va">rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `rmse`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(metrics2$rmse, na.rm = TRUE): argument is not numeric</span></span>
<span><span class="co">#&gt; or logical: returning NA</span></span>
<span><span class="co">#&gt; Center + Scale - RMSE: NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="scenario-2-parallel-cross-validation">Scenario 2: Parallel Cross-validation<a class="anchor" aria-label="anchor" href="#scenario-2-parallel-cross-validation"></a>
</h3>
<p>For larger datasets, run folds in parallel:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup parallel backend</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run CV in parallel</span></span>
<span><span class="va">cv_parallel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>,</span>
<span>  folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_pca</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_pca</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"future"</span>  <span class="co"># Use parallel backend</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Don't forget to reset</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="available-metrics">Available Metrics<a class="anchor" aria-label="anchor" href="#available-metrics"></a>
</h2>
<p>The <code><a href="../reference/measure_reconstruction_error.html">measure_reconstruction_error()</a></code> function provides
several metrics:</p>
<table class="table">
<thead><tr class="header">
<th>Metric</th>
<th>Description</th>
<th>Range</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>mse</code></td>
<td>Mean Squared Error</td>
<td>[0, ∞)</td>
</tr>
<tr class="even">
<td><code>rmse</code></td>
<td>Root Mean Squared Error</td>
<td>[0, ∞)</td>
</tr>
<tr class="odd">
<td><code>mae</code></td>
<td>Mean Absolute Error</td>
<td>[0, ∞)</td>
</tr>
<tr class="even">
<td><code>r2</code></td>
<td>R-squared (coefficient of determination)</td>
<td>(-∞, 1]</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define measure function with multiple metrics</span></span>
<span><span class="va">measure_pca_multi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">test_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="va">reconstructed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconstruct.html">reconstruct</a></span><span class="op">(</span><span class="va">model</span>, scores <span class="op">=</span> <span class="va">test_scores</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/measure_reconstruction_error.html">measure_reconstruction_error</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="va">reconstructed</span>,</span>
<span>                               metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rmse"</span>, <span class="st">"r2"</span>, <span class="st">"mae"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Calculate multiple metrics at once</span></span>
<span><span class="va">cv_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>,</span>
<span>  folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_pca</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_pca_multi</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 1: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 2: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 3: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 4: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; Warning in value[[3L]](cond): Measuring failed for fold 5: all(dim(Xtrue) ==</span></span>
<span><span class="co">#&gt; dim(Xrec)) is not TRUE</span></span>
<span></span>
<span><span class="co"># View all metrics - extract from list column</span></span>
<span><span class="va">all_metrics_multi</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cv_multi</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">all_metrics_multi</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 1</span></span></span>
<span><span class="co">#&gt;   error                                   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> all(dim(Xtrue) == dim(Xrec)) is not TRUE</span></span>
<span></span>
<span><span class="co"># Calculate mean of each metric across folds</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nMean metrics across folds:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Mean metrics across folds:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"RMSE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">all_metrics_multi</span><span class="op">$</span><span class="va">rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `rmse`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(all_metrics_multi$rmse, na.rm = TRUE): argument is not</span></span>
<span><span class="co">#&gt; numeric or logical: returning NA</span></span>
<span><span class="co">#&gt; RMSE: NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"R²:  "</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">all_metrics_multi</span><span class="op">$</span><span class="va">r2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `r2`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(all_metrics_multi$r2, na.rm = TRUE): argument is not</span></span>
<span><span class="co">#&gt; numeric or logical: returning NA</span></span>
<span><span class="co">#&gt; R²:   NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"MAE: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">all_metrics_multi</span><span class="op">$</span><span class="va">mae</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `mae`.</span></span>
<span><span class="co">#&gt; Warning in mean.default(all_metrics_multi$mae, na.rm = TRUE): argument is not</span></span>
<span><span class="co">#&gt; numeric or logical: returning NA</span></span>
<span><span class="co">#&gt; MAE:  NA</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tips-for-effective-cross-validation">Tips for Effective Cross-validation<a class="anchor" aria-label="anchor" href="#tips-for-effective-cross-validation"></a>
</h2>
<div class="section level3">
<h3 id="preprocessing-inside-the-loop">1. Preprocessing Inside the Loop<a class="anchor" aria-label="anchor" href="#preprocessing-inside-the-loop"></a>
</h3>
<p>Always fit preprocessing parameters inside the CV loop:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># WRONG: Preprocessing outside CV</span></span>
<span><span class="va">X_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>  <span class="co"># Uses information from all samples!</span></span>
<span><span class="va">cv_wrong</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X_scaled</span>, <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_pca</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_pca</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># RIGHT: Preprocessing inside CV</span></span>
<span><span class="co"># Let PCA handle preprocessing with the preproc parameter</span></span>
<span><span class="co"># (See preprocessing comparison example above)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="choose-appropriate-fold-sizes">2. Choose Appropriate Fold Sizes<a class="anchor" aria-label="anchor" href="#choose-appropriate-fold-sizes"></a>
</h3>
<ul>
<li>
<strong>Small datasets (&lt; 100 samples)</strong>: Use
leave-one-out or 10-fold CV</li>
<li>
<strong>Medium datasets (100-1000)</strong>: Use 5-10 fold CV</li>
<li>
<strong>Large datasets (&gt; 1000)</strong>: Use 3-5 fold CV or
hold-out validation</li>
</ul>
</div>
<div class="section level3">
<h3 id="consider-metric-choice">3. Consider Metric Choice<a class="anchor" aria-label="anchor" href="#consider-metric-choice"></a>
</h3>
<ul>
<li>Use <strong>RMSE</strong> for general reconstruction quality</li>
<li>Use <strong>R²</strong> to understand proportion of variance
explained</li>
<li>Use <strong>MAE</strong> when outliers are a concern</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="advanced-cross-validating-other-projectors">Advanced: Cross-validating Other Projectors<a class="anchor" aria-label="anchor" href="#advanced-cross-validating-other-projectors"></a>
</h2>
<p>The CV framework works with any projector type:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define fit function for kernel PCA using Nyström approximation</span></span>
<span><span class="va">fit_kernel_pca</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">ncomp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Defaults to linear kernel; pass a custom kernel_func if needed</span></span>
<span>  <span class="fu"><a href="../reference/nystrom_approx.html">nystrom_approx</a></span><span class="op">(</span><span class="va">train_data</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, nlandmarks <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Define measure function</span></span>
<span><span class="va">measure_kernel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">test_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="va">reconstructed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconstruct.html">reconstruct</a></span><span class="op">(</span><span class="va">model</span>, scores <span class="op">=</span> <span class="va">test_scores</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/measure_reconstruction_error.html">measure_reconstruction_error</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="va">reconstructed</span>, metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rmse"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Cross-validate kernel PCA</span></span>
<span><span class="va">cv_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>,</span>
<span>  folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_kernel_pca</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_kernel</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For discriminant analysis with labels (requires passing labels)</span></span>
<span><span class="va">fit_lda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">ncomp</span>, <span class="va">labels</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/discriminant_projector.html">discriminant_projector</a></span><span class="op">(</span><span class="va">train_data</span>, <span class="va">labels</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cv_lda</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>,</span>
<span>  folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_lda</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_pca</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="fl">3</span>, labels <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="kernel-pca-via-nyström-standard-and-double">Kernel PCA via Nyström (standard and double)<a class="anchor" aria-label="anchor" href="#kernel-pca-via-nystr%C3%B6m-standard-and-double"></a>
</h2>
<p>The <code><a href="../reference/nystrom_approx.html">nystrom_approx()</a></code> function provides two variants:</p>
<ul>
<li>
<code>method = "standard"</code>: Williams–Seeger single-stage
Nyström with the usual scaling</li>
<li>
<code>method = "double"</code>: Lim–Jin–Zhang two-stage Nyström
(efficient when <code>p</code> is large)</li>
</ul>
<p>With a centered linear kernel and all points as landmarks
(<code>m = N</code>), the Nyström eigen-decomposition recovers the exact
top eigenpairs of the kernel matrix <code>K = X_c X_c^T</code>. Below is
a reproducible snippet that demonstrates this and shows how to project
new data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">80</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">ncomp</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Exact setting: linear kernel + centering + m = N</span></span>
<span><span class="va">fit_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nystrom_approx.html">nystrom_approx</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, landmarks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, preproc <span class="op">=</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"standard"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare kernel eigenvalues: eig(K) vs fit_std$sdev^2</span></span>
<span><span class="va">Xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform.html">transform</a></span><span class="op">(</span><span class="va">fit_std</span><span class="op">$</span><span class="va">preproc</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">K</span>  <span class="op">&lt;-</span> <span class="va">Xc</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Xc</span><span class="op">)</span></span>
<span><span class="va">lam_K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="va">K</span>, symmetric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">ncomp</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  component <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">ncomp</span>,</span>
<span>  nystrom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">fit_std</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  exact_K  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">lam_K</span>,          decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   component   nystrom   exact_K</span></span>
<span><span class="co">#&gt; 1         1 117.64481 117.64481</span></span>
<span><span class="co">#&gt; 2         2 112.66863 112.66863</span></span>
<span><span class="co">#&gt; 3         3 103.44825 103.44825</span></span>
<span><span class="co">#&gt; 4         4  83.17891  83.17891</span></span>
<span><span class="co">#&gt; 5         5  78.30886  78.30886</span></span>
<span></span>
<span><span class="co"># Relationship with PCA: prcomp() returns singular values / sqrt(n - 1)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">Xc</span>, center <span class="op">=</span> <span class="cn">FALSE</span>, scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">lam_from_pca</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">sdev</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">ncomp</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># equals eig(K)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  component <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">ncomp</span>,</span>
<span>  from_pca  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">lam_from_pca</span>,  decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  exact_K   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">lam_K</span>,         decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   component  from_pca   exact_K</span></span>
<span><span class="co">#&gt; 1         1 117.64481 117.64481</span></span>
<span><span class="co">#&gt; 2         2 112.66863 112.66863</span></span>
<span><span class="co">#&gt; 3         3 103.44825 103.44825</span></span>
<span><span class="co">#&gt; 4         4  83.17891  83.17891</span></span>
<span><span class="co">#&gt; 5         5  78.30886  78.30886</span></span>
<span></span>
<span><span class="co"># Out-of-sample projection for new rows</span></span>
<span><span class="va">new_rows</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="va">scores_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">fit_std</span>, <span class="va">X</span><span class="op">[</span><span class="va">new_rows</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">scores_new</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]         [,2]        [,3]       [,4]       [,5]</span></span>
<span><span class="co">#&gt; [1,] -0.5065700 -0.003782324 -0.89690602 -1.2402365 -0.2466715</span></span>
<span><span class="co">#&gt; [2,] -0.3673067  0.489430969 -1.23213982 -1.5330320  0.7247966</span></span>
<span><span class="co">#&gt; [3,]  1.9065578 -0.008104080 -0.61654002  1.5191661  1.2188904</span></span>
<span><span class="co">#&gt; [4,] -1.5843734 -0.908340577 -0.94045424 -2.8897545 -2.0328659</span></span>
<span><span class="co">#&gt; [5,]  0.5690207  0.002415067  0.09988366 -0.0194067  0.5888599</span></span>
<span></span>
<span><span class="co"># Double Nyström collapses to standard when l = m = N</span></span>
<span><span class="va">fit_dbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nystrom_approx.html">nystrom_approx</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, landmarks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, preproc <span class="op">=</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"double"</span>, l <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">fit_std</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">fit_dbl</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>For large feature counts (<code>p &gt;&gt; n</code>), set
<code>method = "double"</code> and choose a modest intermediate rank
<code>l</code> to reduce the small problem size. Provide a custom
<code>kernel_func</code> if you need a non-linear kernel (e.g.,
RBF).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example RBF kernel</span></span>
<span><span class="va">gaussian_kernel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">B</span>, <span class="va">sigma</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ||a-b||^2 = ||a||^2 + ||b||^2 - 2 a·b</span></span>
<span>  <span class="va">G</span>  <span class="op">&lt;-</span> <span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span>
<span>  <span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">A</span> <span class="op">*</span> <span class="va">A</span><span class="op">)</span></span>
<span>  <span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">B</span> <span class="op">*</span> <span class="va">B</span><span class="op">)</span></span>
<span>  <span class="va">D2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">a2</span>, <span class="va">b2</span>, <span class="st">"+"</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">G</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">D2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fit_rbf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nystrom_approx.html">nystrom_approx</a></span><span class="op">(</span></span>
<span>  <span class="va">X</span>, ncomp <span class="op">=</span> <span class="fl">8</span>, nlandmarks <span class="op">=</span> <span class="fl">40</span>, preproc <span class="op">=</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"double"</span>, l <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  kernel_func <span class="op">=</span> <span class="va">gaussian_kernel</span></span>
<span><span class="op">)</span></span>
<span><span class="va">scores_rbf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">fit_rbf</span>, <span class="va">X</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="test-coverage-for-nyström">Test coverage for Nyström<a class="anchor" aria-label="anchor" href="#test-coverage-for-nystr%C3%B6m"></a>
</h3>
<p>This package includes unit tests that validate Nyström
correctness:</p>
<ul>
<li>Standard Nyström recovers the exact kernel eigenpairs when
<code>m = N</code> (centered linear kernel)</li>
<li>Double Nyström matches standard when <code>l = m = N</code>
</li>
<li>
<code><a href="../reference/project.html">project()</a></code> reproduces training scores and matches manual
formulas for both methods</li>
</ul>
<p>See <code>tests/testthat/test_nystrom.R</code> in the source for
details.</p>
</div>
<div class="section level3">
<h3 id="crossvalidated-kernel-rmse-nyström-vs-pca">Cross‑validated kernel RMSE: Nyström vs PCA<a class="anchor" aria-label="anchor" href="#crossvalidated-kernel-rmse-nystr%C3%B6m-vs-pca"></a>
</h3>
<p>Below we compare PCA and Nyström (linear kernel) via a kernel‑space
RMSE on held‑out folds. For a test block with preprocessed data
<code>X_test_c</code>, the true kernel is
<code>K_true = X_test_c %*% t(X_test_c)</code>. With a
rank‑<code>k</code> model, the approximated kernel is
<code>K_hat = S %*% t(S)</code>, where <code>S</code> are the component
scores returned by <code><a href="../reference/project.html">project()</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">202</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PCA fit function (reuses earlier fit_pca)</span></span>
<span><span class="va">fit_pca</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">ncomp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/pca.html">pca</a></span><span class="op">(</span><span class="va">train_data</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, preproc <span class="op">=</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Nyström fit function (standard variant, linear kernel, no RSpectra needed for small data)</span></span>
<span><span class="va">fit_nystrom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">ncomp</span>, <span class="va">nlandmarks</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/nystrom_approx.html">nystrom_approx</a></span><span class="op">(</span><span class="va">train_data</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, nlandmarks <span class="op">=</span> <span class="va">nlandmarks</span>,</span>
<span>                 preproc <span class="op">=</span> <span class="fu"><a href="../reference/center.html">center</a></span><span class="op">(</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"standard"</span>, use_RSpectra <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Kernel-space RMSE metric for a test fold</span></span>
<span><span class="va">measure_kernel_rmse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="va">K_hat</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span>
<span>  <span class="va">Xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reprocess.html">reprocess</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="va">K_true</span> <span class="op">&lt;-</span> <span class="va">Xc</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Xc</span><span class="op">)</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>kernel_rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">K_hat</span> <span class="op">-</span> <span class="va">K_true</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use a local copy of iris data and local folds for this comparison</span></span>
<span><span class="va">X_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">fold_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_cv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">folds_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fold_ids</span> <span class="op">!=</span> <span class="va">k</span><span class="op">)</span>,</span>
<span>  test  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fold_ids</span> <span class="op">==</span> <span class="va">k</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare for k = 3 components</span></span>
<span><span class="va">k_sel</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">cv_pca_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X_cv</span>, <span class="va">folds_cv</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_pca</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_kernel_rmse</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="va">k_sel</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cv_nys_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_generic.html">cv_generic</a></span><span class="op">(</span></span>
<span>  <span class="va">X_cv</span>, <span class="va">folds_cv</span>,</span>
<span>  .fit_fun <span class="op">=</span> <span class="va">fit_nystrom</span>,</span>
<span>  .measure_fun <span class="op">=</span> <span class="va">measure_kernel_rmse</span>,</span>
<span>  fit_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncomp <span class="op">=</span> <span class="va">k_sel</span>, nlandmarks <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">metrics_pca</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cv_pca_kernel</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span><span class="va">metrics_nys</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cv_nys_kernel</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span><span class="va">rmse_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">metrics_pca</span><span class="op">$</span><span class="va">kernel_rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rmse_nys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">metrics_nys</span><span class="op">$</span><span class="va">kernel_rmse</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cv_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PCA"</span>, <span class="st">"Nyström (linear)"</span><span class="op">)</span>,</span>
<span>  kernel_rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rmse_pca</span>, <span class="va">rmse_nys</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cv_summary</span><span class="op">)</span></span>
<span><span class="co">#&gt;             method kernel_rmse</span></span>
<span><span class="co">#&gt; 1              PCA  0.02153248</span></span>
<span><span class="co">#&gt; 2 Nyström (linear)  0.02266859</span></span>
<span></span>
<span><span class="co"># Simple bar plot</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">cv_summary</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">kernel_rmse</span>, fill <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cross‑validated kernel RMSE (k = 3)"</span>, y <span class="op">=</span> <span class="st">"Kernel RMSE"</span>, x <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="CrossValidation_files/figure-html/nystrom_cv_compare-1.png" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The <code>multivarious</code> CV framework provides: - Easy
cross-validation for any dimensionality reduction method - Flexible
metric calculation - Parallel execution support - Tidy output format for
easy analysis</p>
<p>Use it to make informed decisions about model complexity and ensure
your dimensionality reduction generalizes well to new data.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bradley Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
